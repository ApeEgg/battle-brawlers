<script lang="ts">
  import Checkbox from './form/Checkbox.svelte';

  let showSidebar = $state(false);
</script>

<crow
  class={tw(
    'fixed top-20 bottom-0 left-[calc(100%-theme(spacing.10))] z-100 max-w-100 !flex-none overflow-hidden overflow-y-scroll pl-10 transition-transform duration-200',
    (showSidebar || app.settings.debugOpen) && '-translate-x-[calc(100%-theme(spacing.10))]'
  )}
  role="none"
  onmouseenter={() => (showSidebar = true)}
  onmouseleave={() => !app.settings.debugOpen && (showSidebar = false)}
>
  <crow left vertical up class={tw('glass')}>
    <div class="mb-0 w-full p-2 pb-0">
      <Headline text="Debug" small>
        <div>
          <Checkbox
            id="keepOpen"
            bind:value={app.settings.debugOpen}
            onchange={({ target: { checked } }: any) => (app.settings.debugOpen = checked)}
          >
            Keep open
          </Checkbox>
        </div>
      </Headline>
    </div>
    {#if app.combat.duration <= 0}
      {#each Object.entries(app.dump()) as [key, value]}
        {@const isOpenable = typeof value === 'object'}
        {@const openValue = app.settings.openProperties?.[key]}
        {@const isOpen = isOpenable && !!openValue}
        <Clickable
          class={tw('w-full hover:cursor-pointer hover:bg-gray-500/20', isOpen && 'bg-gray-500/20')}
          onclick={() => {
            if (openValue) {
              delete app.settings.openProperties[key];
            } else {
              app.settings.openProperties[key] = true;
            }
          }}
        >
          <crow vertical left class="w-full">
            <crow class="w-full !justify-between" up left>
              <div class="px-2 py-1 font-bold">{key}</div>
              <crow class="!flex-none">
                {#if isOpenable}
                  <span class="">
                    {Math.max(
                      0,
                      Array.isArray(value) ? value.length : Object.keys(value || {}).length
                    )}
                  </span>
                {:else}
                  {value || '-'}
                {/if}
                <crow class={tw('aspect-square w-8 !flex-none')}>
                  {#if isOpenable}
                    <Icon
                      name="down"
                      class={tw(
                        '-rotate-90 text-xs transition-transform duration-200',
                        isOpen && 'rotate-0'
                      )}
                    />
                  {/if}
                </crow>
              </crow>
            </crow>
            <Accordion {isOpen}>
              <crow up left class="w-full">
                <code class="text-left">
                  <pre class="p-2 text-[10px]">{JSON.stringify(
                      value,
                      (_, value) => {
                        if (value === undefined) return null;

                        return value;
                      },
                      2
                    )}</pre>
                </code>
              </crow>
            </Accordion>
          </crow>
        </Clickable>
      {/each}
      <!-- <pre class="text-xs">{JSON.stringify(app.dump(), null, 2)}
    </pre> -->
    {/if}
  </crow>
</crow>
